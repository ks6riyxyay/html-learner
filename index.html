<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>W3Clone LMS - Transformers AI (WORKING)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{--g:#04aa6d;--bg:#fff;--tx:#000;--p:#f1f1f1}
body.dark{--bg:#1e1f26;--tx:#eee;--p:#2a2c35}
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI;background:var(--bg);color:var(--tx)}
header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;border-bottom:1px solid #ccc}
.logo{font-size:26px;font-weight:900;color:var(--g)}
.wrap{display:flex;height:calc(100vh - 55px)}
nav{width:320px;background:var(--p);overflow:auto}
nav a{display:block;padding:8px 15px;cursor:pointer}
nav a.locked{opacity:.4;pointer-events:none}
nav a.active{background:var(--g);color:#fff}
main{flex:1;padding:25px;overflow:auto}
.btn{background:var(--g);color:#fff;border:none;padding:6px 12px;font-weight:bold;cursor:pointer}
.editor{background:#e7e9eb;padding:12px;border-left:5px solid var(--g);margin:15px 0}
textarea{width:100%;height:140px;font-family:monospace}
iframe{width:100%;height:200px;border:1px solid #ccc}
.box{background:var(--p);padding:12px;border-radius:6px;margin:12px 0}
input{padding:6px;width:100%;margin:5px 0}
</style>
</head>
<body>

<header>
  <div class="logo">W3Clone LMS</div>
  <div>
    <button class="btn" onclick="toggleDark()">üåô</button>
    <button class="btn" onclick="logout()">Logout</button>
  </div>
</header>

<div class="wrap">
  <nav id="nav"></nav>
  <main id="main"></main>
</div>

<!-- TRANSFORMERS UMD (No import) -->
<script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@latest/dist/transformers.min.js"></script>

<script>
/* ---------- TRANSFORMERS AI ---------- */
let generator = null;

async function loadAI(){
  if(generator) return generator;
  generator = await transformers.pipeline("text-generation", "Xenova/distilgpt2");
  return generator;
}

async function aiGenerate(prompt){
  const model = await loadAI();
  const out = await model(prompt, { max_new_tokens: 120 });
  return out[0].generated_text;
}

/* ---------- AUTH ---------- */
async function sha256(str){
  const buffer = new TextEncoder("utf-8").encode(str);
  const hash = await crypto.subtle.digest("SHA-256", buffer);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function authScreen(){
  document.getElementById("nav").innerHTML="";
  document.getElementById("main").innerHTML=`
    <div style="max-width:400px;margin:60px auto">
      <h1>Login / Register</h1>
      <input id="u" placeholder="Username">
      <input id="p" type="password" placeholder="Password">
      <button class="btn" onclick="login()">Login</button>
      <button class="btn" onclick="register()">Register</button>
      <p style="margin-top:10px;color:#555;">Local auth only (no API).</p>
    </div>
  `;
}

async function register(){
  const u=document.getElementById("u").value.trim();
  const p=document.getElementById("p").value;
  if(!u||!p) return alert("Enter username & password");
  if(localStorage.getItem("user:"+u)) return alert("User exists");
  const h=await sha256(p);
  localStorage.setItem("user:"+u, JSON.stringify({pw:h,done:[],exam:false,admin:false}));
  alert("Registered");
}

async function login(){
  const u=document.getElementById("u").value.trim();
  const p=document.getElementById("p").value;
  if(!u||!p) return alert("Enter username & password");
  const stored=localStorage.getItem("user:"+u);
  if(!stored) return alert("User not found");
  const obj=JSON.parse(stored);
  const h=await sha256(p);
  if(h!==obj.pw) return alert("Wrong password");
  localStorage.setItem("session", u);
  loadApp();
}

function logout(){
  localStorage.removeItem("session");
  location.reload();
}

/* ---------- LESSONS ---------- */
let user, data;
const lessons = [];
for(let i=1;i<=50;i++){
  lessons.push({
    id:"l"+i,
    title:"Lesson "+i+" - HTML/CSS/JS Topic",
    content:"Real lesson content placeholder. Replace with real text if you want. This is a working system.",
    example:`<h1>Lesson ${i}</h1><p>Example code for lesson ${i}</p>`
  });
}

/* ---------- APP ---------- */
function loadApp(){
  user=localStorage.getItem("session");
  if(!user) return authScreen();
  data=JSON.parse(localStorage.getItem("user:"+user));
  if(!data) return authScreen();

  if(user==="webwoner") data.admin=true;
  renderNav();
  loadLesson(data.done.length);
}

function renderNav(){
  const nav=document.getElementById("nav");
  nav.innerHTML="";
  lessons.forEach((l,i)=>{
    const a=document.createElement("a");
    a.textContent=l.title;
    if(i>data.done.length) a.classList.add("locked");
    a.onclick=()=>loadLesson(i);
    a.id=l.id;
    nav.appendChild(a);
  });
  nav.innerHTML += `
    <a onclick="exam()">üß™ Final Exam</a>
    <a onclick="certificate()">üéì Certificate</a>
    <a onclick="leaderboard()">üèÜ Leaderboard</a>
    <a onclick="adminPanel()">üõ† Admin</a>
  `;
}

function loadLesson(index){
  if(index>data.done.length) return alert("Complete previous lessons first üîí");
  document.querySelectorAll("nav a").forEach(a=>a.classList.remove("active"));
  document.getElementById(lessons[index].id).classList.add("active");

  const l=lessons[index];
  document.getElementById("main").innerHTML=`
    <div class="box">Progress: ${Math.round(data.done.length/lessons.length*100)}%</div>
    <h1>${l.title}</h1>
    <p>${l.content}</p>

    <div class="editor">
      <textarea>${l.example}</textarea>
      <button class="btn" onclick="run(this)">Run</button>
      <iframe></iframe>
    </div>

    <button class="btn" onclick="complete(${index})">‚úî Complete Lesson</button>

    <div class="box">
      <input id="aiq" placeholder="Ask AI about this lesson">
      <button class="btn" onclick="askAI('${l.title}')">ü§ñ Ask AI</button>
      <div id="aiout"></div>
    </div>
  `;
}

function run(btn){
  btn.nextElementSibling.srcdoc = btn.previousElementSibling.value;
}

function complete(index){
  if(!data.done.includes(index)){
    data.done.push(index);
    localStorage.setItem("user:"+user, JSON.stringify(data));
    renderNav();
    loadLesson(data.done.length);
  }
}

async function askAI(topic){
  const question=document.getElementById("aiq").value;
  if(!question) return alert("Ask a question");
  document.getElementById("aiout").innerHTML="Generating... (first time may take 20-40s)";
  const prompt=`You are a coding tutor. Topic: ${topic}\nQuestion: ${question}\nAnswer:`;
  const answer=await aiGenerate(prompt);
  document.getElementById("aiout").innerHTML=`<pre>${answer}</pre>`;
}

/* ---------- EXAM ---------- */
const examQuestions = [
  {q:"HTML stands for?", a:"HyperText Markup Language"},
  {q:"CSS stands for?", a:"Cascading Style Sheets"},
  {q:"JS is used for?", a:"Interactivity"},
  {q:"Link tag is?", a:"a"},
  {q:"CSS property for color?", a:"color"}
];

function exam(){
  if(data.done.length<lessons.length) return alert("Finish all lessons first");
  let score=0;
  for(let q of examQuestions){
    const ans=prompt(q.q);
    if(ans && ans.toLowerCase().includes(q.a.toLowerCase())) score++;
  }
  const pass=score>=4;
  if(pass){ data.exam=true; localStorage.setItem("user:"+user, JSON.stringify(data)); alert("Exam passed ‚úî"); }
  else alert("Exam failed ‚ùå");
}

function certificate(){
  if(!data.exam || data.done.length<lessons.length) return alert("Complete all lessons + pass exam");
  const c=document.createElement("canvas");
  c.width=800; c.height=400;
  const ctx=c.getContext("2d");
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,800,400);
  ctx.fillStyle="#000"; ctx.font="36px serif";
  ctx.fillText("Certificate of Completion",120,150);
  ctx.font="24px serif";
  ctx.fillText(user,340,230);
  const a=document.createElement("a");
  a.href=c.toDataURL(); a.download="certificate.png"; a.click();
}

function leaderboard(){
  let arr=[];
  for(let k in localStorage){
    if(!k.startsWith("user:")) continue;
    const d=JSON.parse(localStorage[k]);
    arr.push({u:k.replace("user:",""), score:d.done.length});
  }
  arr.sort((a,b)=>b.score-a.score);
  document.getElementById("main").innerHTML="<h1>Leaderboard</h1>" + arr.map(x=>`<p>${x.u}: ${x.score}/${lessons.length}</p>`).join("");
}

function adminPanel(){
  if(!data.admin) return alert("Access denied");
  const secret=prompt("Admin pass");
  if(secret !== "adminSecret") return alert("Wrong");
  const action=prompt("Admin action: resetProgress / addLesson");
  if(action==="resetProgress"){
    data.done=[]; data.exam=false;
    localStorage.setItem("user:"+user, JSON.stringify(data));
    renderNav(); loadLesson(0);
    alert("Reset");
  }
  if(action==="addLesson"){
    const title=prompt("Lesson title");
    const content=prompt("Lesson content");
    const example=prompt("Lesson example");
    lessons.push({id:"l"+lessons.length, title, content, example});
    renderNav();
    alert("Added");
  }
}

function toggleDark(){document.body.classList.toggle("dark")}
loadApp();
</script>

</body>
</html>
