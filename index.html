<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>W3Clone LMS + AI Code Review</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{--g:#04aa6d;--bg:#fff;--tx:#000;--p:#f1f1f1}
body.dark{--bg:#1e1f26;--tx:#eee;--p:#2a2c35}
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI;background:var(--bg);color:var(--tx)}
header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;border-bottom:1px solid #ccc}
.logo{font-size:26px;font-weight:900;color:var(--g)}
.wrap{display:flex;height:calc(100vh - 55px)}
nav{width:320px;background:var(--p);overflow:auto}
nav a{display:block;padding:8px 15px;cursor:pointer;text-decoration:none;color:inherit}
nav a.locked{opacity:.4;pointer-events:none}
nav a.active{background:var(--g);color:#fff}
main{flex:1;padding:25px;overflow:auto}
.btn{background:var(--g);color:#fff;border:none;padding:6px 12px;font-weight:bold;cursor:pointer}
.editor{background:#e7e9eb;padding:12px;border-left:5px solid var(--g);margin:15px 0}
textarea{width:100%;height:140px;font-family:monospace}
iframe{width:100%;height:200px;border:1px solid #ccc}
.box{background:var(--p);padding:12px;border-radius:6px;margin:12px 0}
input, select{padding:6px;width:100%;margin:5px 0}
.ai-panel{background:#e7e9eb;padding:15px;border-radius:8px;margin:15px 0}
.ai-output{background:#fff;padding:12px;border:1px solid #ccc;min-height:120px;white-space:pre-wrap}
</style>
</head>
<body>

<header>
  <div class="logo">W3Clone LMS + AI</div>
  <div>
    <button class="btn" onclick="toggleDark()">üåô</button>
    <button class="btn" onclick="logout()">Logout</button>
  </div>
</header>

<div class="wrap">
  <nav id="nav"></nav>
  <main id="main"></main>
</div>

<!-- Transformers.js -->
<script type="module">
import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0/dist/transformers.esm.js";

async function loadModel() {
  if (window.model) return window.model;
  window.model = await pipeline("text-generation", "Xenova/gpt2");
  return window.model;
}

async function aiAsk(prompt) {
  const model = await loadModel();
  const res = await model(prompt, { max_new_tokens: 120 });
  return res[0].generated_text;
}

async function aiLesson(topic) {
  const prompt = `
Create a full lesson on: ${topic}
Include:
- Explanation
- Example code
- Quiz with 3 questions
- Summary
Format:
Lesson:
Code:
Quiz:
Summary:
`;
  return await aiAsk(prompt);
}

async function aiReview(code) {
  const prompt = `
You are a professional code reviewer.
Review this code and provide:
1. Problems
2. Improvements
3. Best practices
4. Suggestions
Code:
${code}
`;
  return await aiAsk(prompt);
}

window.aiAsk = aiAsk;
window.aiLesson = aiLesson;
window.aiReview = aiReview;
</script>

<script>
async function sha256(str){
  const buffer = new TextEncoder("utf-8").encode(str);
  const hash = await crypto.subtle.digest("SHA-256", buffer);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function authScreen(){
  document.getElementById("nav").innerHTML="";
  document.getElementById("main").innerHTML=`
    <div style="max-width:400px;margin:60px auto">
      <h1>Login / Register</h1>
      <input id="u" placeholder="Username">
      <input id="p" type="password" placeholder="Password">
      <button class="btn" onclick="login()">Login</button>
      <button class="btn" onclick="register()">Register</button>
      <p style="margin-top:10px;color:#555;">Local auth only (no API).</p>
    </div>
  `;
}

async function register(){
  const u=document.getElementById("u").value.trim();
  const p=document.getElementById("p").value;
  if(!u||!p) return alert("Enter username & password");
  if(localStorage.getItem("user:"+u)) return alert("User exists");
  const h=await sha256(p);
  localStorage.setItem("user:"+u, JSON.stringify({pw:h,done:[],exam:false,admin:false}));
  alert("Registered");
}

async function login(){
  const u=document.getElementById("u").value.trim();
  const p=document.getElementById("p").value;
  if(!u||!p) return alert("Enter username & password");
  const stored=localStorage.getItem("user:"+u);
  if(!stored) return alert("User not found");
  const obj=JSON.parse(stored);
  const h=await sha256(p);
  if(h!==obj.pw) return alert("Wrong password");
  localStorage.setItem("session", u);
  loadApp();
}

function logout(){
  localStorage.removeItem("session");
  location.reload();
}

/* ---------- LESSONS ---------- */
const lessons = [];
for (let i=1;i<=50;i++){
  lessons.push({
    id:"l"+i,
    title:"Lesson "+i,
    content:"This is lesson "+i+". (Replace with real content later.)",
    example:"<p>Example code for lesson "+i+"</p>"
  });
}

let user, data;

function loadApp(){
  user=localStorage.getItem("session");
  if(!user) return authScreen();
  data=JSON.parse(localStorage.getItem("user:"+user));
  if(!data) return authScreen();

  // ADMIN ONLY for webwoner
  if(user === "webwoner") data.admin=true;
  localStorage.setItem("user:"+user, JSON.stringify(data));

  renderNav();
  loadLesson(data.done.length);
}

function renderNav(){
  const nav=document.getElementById("nav");
  nav.innerHTML="";
  lessons.forEach((l,i)=>{
    const a=document.createElement("a");
    a.textContent=l.title;
    a.href="#";
    if(i>data.done.length) a.classList.add("locked");
    a.onclick=(e)=>{e.preventDefault(); loadLesson(i);}
    a.id=l.id;
    nav.appendChild(a);
  });

  nav.innerHTML += `
    <a href="#" onclick="event.preventDefault(); exam()">üß™ Final Exam</a>
    <a href="#" onclick="event.preventDefault(); certificate()">üéì Certificate</a>
    <a href="#" onclick="event.preventDefault(); leaderboard()">üèÜ Leaderboard</a>
    ${data.admin ? `<a href="#" onclick="event.preventDefault(); adminPanel()">üõ† Admin</a>` : ""}
  `;
}

function loadLesson(index){
  if(index>data.done.length) return alert("Complete previous lessons first üîí");
  document.querySelectorAll("nav a").forEach(a=>a.classList.remove("active"));
  document.getElementById(lessons[index].id).classList.add("active");
  const l=lessons[index];

  document.getElementById("main").innerHTML=`
    <div class="box">Progress: ${Math.round(data.done.length/lessons.length*100)}%</div>
    <h1>${l.title}</h1>
    <p>${l.content}</p>

    <div class="editor">
      <textarea id="codeBox">${l.example}</textarea>
      <button class="btn" onclick="run()">Run</button>
      <iframe id="frame"></iframe>
    </div>

    <button class="btn" onclick="complete(${index})">‚úî Complete Lesson</button>

    <div class="ai-panel">
      <h2>AI Tutor</h2>
      <select id="aiMode">
        <option value="ask">Ask Question</option>
        <option value="lesson">Generate Lesson</option>
        <option value="review">AI Code Review</option>
      </select>
      <input id="aiInput" placeholder="Type question or topic (or press review)">
      <button class="btn" onclick="runAI()">Run AI</button>
      <div id="aiOutput" class="ai-output">AI output will appear here.</div>
    </div>
  `;
}

function run(){
  const code = document.getElementById("codeBox").value;
  document.getElementById("frame").srcdoc = code;
}

function complete(index){
  if(!data.done.includes(index)){
    data.done.push(index);
    localStorage.setItem("user:"+user, JSON.stringify(data));
    renderNav();
    loadLesson(data.done.length);
  }
}

const examQuestions = [
  {q:"HTML stands for?", a:"HyperText Markup Language"},
  {q:"CSS stands for?", a:"Cascading Style Sheets"},
  {q:"JS is used for?", a:"Interactivity"},
  {q:"Link tag is?", a:"a"},
  {q:"CSS property for color?", a:"color"}
];

function exam(){
  if(data.done.length<lessons.length) return alert("Finish all lessons first");
  let score=0;
  for(let q of examQuestions){
    const ans=prompt(q.q);
    if(ans && ans.toLowerCase().includes(q.a.toLowerCase())) score++;
  }
  const pass=score>=4;
  if(pass){ data.exam=true; localStorage.setItem("user:"+user, JSON.stringify(data)); alert("Exam passed ‚úî"); }
  else alert("Exam failed ‚ùå");
}

function certificate(){
  if(!data.exam || data.done.length<lessons.length) return alert("Complete all lessons + pass exam");
  const c=document.createElement("canvas");
  c.width=800; c.height=400;
  const ctx=c.getContext("2d");
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,800,400);
  ctx.fillStyle="#000"; ctx.font="36px serif";
  ctx.fillText("Certificate of Completion",120,150);
  ctx.font="24px serif";
  ctx.fillText(user,340,230);
  const a=document.createElement("a");
  a.href=c.toDataURL(); a.download="certificate.png"; a.click();
}

function leaderboard(){
  let arr=[];
  Object.keys(localStorage).forEach(k=>{
    if(!k.startsWith("user:")) return;
    const d=JSON.parse(localStorage[k]);
    arr.push({u:k.replace("user:",""), score:d.done.length});
  });
  arr.sort((a,b)=>b.score-a.score);
  document.getElementById("main").innerHTML="<h1>Leaderboard</h1>" + arr.map(x=>`<p>${x.u}: ${x.score}/${lessons.length}</p>`).join("");
}

function adminPanel(){
  if(!data.admin) return alert("Access denied");
  const secret = prompt("Enter admin pass:");
  if(secret !== "superSecret123") return alert("Wrong pass");

  const action=prompt("Admin actions: resetProgress / unlockAll");
  if(action==="resetProgress"){
    data.done=[]; data.exam=false;
    localStorage.setItem("user:"+user, JSON.stringify(data));
    renderNav(); loadLesson(0);
    alert("Reset");
  }
  if(action==="unlockAll"){
    data.done = Array.from({length:lessons.length},(_,i)=>i);
    data.exam=true;
    localStorage.setItem("user:"+user, JSON.stringify(data));
    renderNav(); loadLesson(lessons.length-1);
    alert("Unlocked all");
  }
}

async function runAI(){
  const mode = document.getElementById("aiMode").value;
  const input = document.getElementById("aiInput").value.trim();
  const out = document.getElementById("aiOutput");
  out.textContent = "Loading AI model... (this can take 20‚Äì60 seconds on first run)";

  try{
    if(mode==="ask"){
      const ans = await window.aiAsk("Explain: " + input);
      out.textContent = ans;
    } else if(mode==="lesson"){
      const ans = await window.aiLesson(input);
      out.textContent = ans;
    } else {
      const code = document.getElementById("codeBox").value;
      const ans = await window.aiReview(code);
      out.textContent = ans;
    }
  } catch(e){
    out.textContent = "AI failed: " + e.message;
  }
}

function toggleDark(){document.body.classList.toggle("dark")}
loadApp();
</script>
</body>
</html>
