<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>W3Clone LMS - Admin Lock</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.8.0/dist/transformers.min.js"></script>

<style>
:root{--g:#04aa6d;--bg:#fff;--tx:#000;--p:#f1f1f1}
body.dark{--bg:#1e1f26;--tx:#eee;--p:#2a2c35}
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI;background:var(--bg);color:var(--tx)}
header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;border-bottom:1px solid #ccc}
.logo{font-size:26px;font-weight:900;color:var(--g)}
.wrap{display:flex;height:calc(100vh - 55px)}
nav{width:340px;background:var(--p);overflow:auto}
nav a{display:block;padding:8px 15px;cursor:pointer}
nav a.locked{opacity:.4;pointer-events:none}
nav a.active{background:var(--g);color:#fff}
main{flex:1;padding:25px;overflow:auto}
.btn{background:var(--g);color:#fff;border:none;padding:6px 12px;font-weight:bold;cursor:pointer}
.editor{background:#e7e9eb;padding:12px;border-left:5px solid var(--g);margin:15px 0}
textarea{width:100%;height:140px;font-family:monospace}
iframe{width:100%;height:200px;border:1px solid #ccc}
.box{background:var(--p);padding:12px;border-radius:6px;margin:12px 0}
input, select{padding:6px;width:100%;margin:5px 0}
small{color:#666}
</style>
</head>

<body>
<header>
  <div class="logo">W3Clone LMS</div>
  <div>
    <button class="btn" onclick="toggleDark()">üåô</button>
    <button class="btn" onclick="voice()">üé§</button>
    <button class="btn" onclick="openLeaderboard()">üèÜ Leaderboard</button>
    <button class="btn" onclick="logout()">Logout</button>
  </div>
</header>

<div class="wrap">
  <nav id="nav"></nav>
  <main id="main"></main>
</div>

<script>
/* ---------- AI ---------- */
let ai;
(async()=>ai=await transformers.pipeline("text-generation","Xenova/distilgpt2"))();

/* ---------- AUTH ---------- */
let session = localStorage.session;
if(!session) authScreen();
else loadUser(session);

function authScreen(){
  document.body.innerHTML=`
    <main style="max-width:400px;margin:60px auto">
      <h1>Login / Register</h1>
      <input id="u" placeholder="Username">
      <input id="p" type="password" placeholder="Password">
      <button class="btn" onclick="login()">Login</button>
      <button class="btn" onclick="register()">Register</button>
      <div class="box">
        <small>Admin user is <b>webwoner</b></small>
      </div>
    </main>`;
}

async function hash(t){
  const b=new TextEncoder().encode(t);
  const h=await crypto.subtle.digest("SHA-256",b);
  return [...new Uint8Array(h)].map(x=>x.toString(16).padStart(2,"0")).join("");
}

async function register(){
  const u=document.getElementById("u").value.trim();
  const p=document.getElementById("p").value;
  if(!u||!p) return alert("Enter username + password");
  if(localStorage[u]) return alert("User exists");
  const pw=await hash(p);
  localStorage[u]=JSON.stringify({
    pw,
    done:[],
    scores:{},
    exam:false,
    admin: u === "webwoner" // ONLY webwoner is admin
  });
  login();
}

async function login(){
  const u=document.getElementById("u").value.trim();
  const p=document.getElementById("p").value;
  const user=JSON.parse(localStorage[u]||"null");
  if(!user) return alert("User not found");
  const pw=await hash(p);
  if(pw!==user.pw) return alert("Wrong password");
  localStorage.session=u;
  location.reload();
}

function logout(){localStorage.removeItem("session");location.reload();}

/* ---------- DATA ---------- */
const courses=[
  {id:"html",name:"HTML",lessons:[
    {id:"h1",title:"What is HTML?",content:"HTML is a markup language that defines structure of web pages."},
    {id:"h2",title:"HTML Document Structure",content:"Every HTML page has <!DOCTYPE html>, <html>, <head>, and <body>."},
    {id:"h3",title:"Headings",content:"Use <h1> to <h6> for headings."},
    {id:"h4",title:"Paragraphs",content:"Use <p> for paragraphs."},
    {id:"h5",title:"Text Formatting",content:"<b>, <i>, <strong>, <em>, <mark>."},
    {id:"h6",title:"Links",content:"<a href='url'>Link</a>."},
    {id:"h7",title:"Images",content:"<img src='url' alt='desc'>."},
    {id:"h8",title:"Lists",content:"<ul>, <ol>, <li>."},
    {id:"h9",title:"Tables",content:"<table>, <tr>, <td>, <th>."},
    {id:"h10",title:"Forms",content:"<form> with inputs, labels, buttons."},
    {id:"h11",title:"Input Types",content:"text, password, email, number, date, checkbox, radio."},
    {id:"h12",title:"Buttons",content:"<button> and input type='submit'."},
    {id:"h13",title:"Div vs Span",content:"div is block, span is inline."},
    {id:"h14",title:"Semantic HTML",content:"<header>, <footer>, <section>, <article>."},
    {id:"h15",title:"Meta Tags",content:"<meta charset='utf-8'>, viewport, description."},
    {id:"h16",title:"Media",content:"<audio> and <video> tags."},
    {id:"h17",title:"Iframes",content:"<iframe src='url'></iframe>."},
    {id:"h18",title:"Forms Validation",content:"required, pattern, min, max, email type."},
    {id:"h19",title:"Accessibility",content:"Use alt, labels, aria attributes."},
    {id:"h20",title:"HTML Best Practices",content:"Use semantic tags, proper indentation, alt text."}
  ], exam:[
    {q:"HTML stands for?",o:["Hyper Text Markup Language","High Text Machine Language","Hyperlinks Text Mark Language"],a:0},
    {q:"Which tag is for a link?",o:["<a>","<link>","<href>"],a:0},
    {q:"Which tag is for an image?",o:["<img>","<image>","<pic>"],a:0},
    {q:"Semantic tag example?",o:["<header>","<div>","<span>"],a:0}
  ]},

  {id:"css",name:"CSS",lessons:[
    {id:"c1",title:"What is CSS?",content:"CSS styles HTML and controls layout, color, fonts, spacing."},
    {id:"c2",title:"CSS Syntax",content:"selector { property: value; }"},
    {id:"c3",title:"Selectors",content:"Element, class, id selectors: h1, .class, #id."},
    {id:"c4",title:"Colors",content:"Named colors, hex (#fff), rgb(), rgba()."},
    {id:"c5",title:"Units",content:"px, em, rem, %, vw, vh."},
    {id:"c6",title:"Box Model",content:"Content + padding + border + margin."},
    {id:"c7",title:"Borders",content:"border-style, border-width, border-color."},
    {id:"c8",title:"Margin",content:"Space outside element."},
    {id:"c9",title:"Padding",content:"Space inside element."},
    {id:"c10",title:"Fonts",content:"font-family, font-size, font-weight."},
    {id:"c11",title:"Text Styling",content:"color, text-align, text-decoration."},
    {id:"c12",title:"Display",content:"block, inline, inline-block."},
    {id:"c13",title:"Position",content:"static, relative, absolute, fixed."},
    {id:"c14",title:"Flexbox",content:"display:flex; align-items; justify-content."},
    {id:"c15",title:"Grid",content:"display:grid; grid-template-columns."},
    {id:"c16",title:"Responsive Design",content:"Use flexible layouts and media queries."},
    {id:"c17",title:"Media Queries",content:"@media (max-width: 600px) { ... }"},
    {id:"c18",title:"Transitions",content:"transition: property duration."},
    {id:"c19",title:"Animations",content:"@keyframes + animation property."},
    {id:"c20",title:"CSS Variables",content:"--main-color: #04aa6d; var(--main-color)."}
  ], exam:[
    {q:"CSS stands for?",o:["Cascading Style Sheets","Colorful Style Sheets","Computer Style Sheets"],a:0},
    {q:"Select by class?",o:[".class","class=","#class"],a:0},
    {q:"Flex container property?",o:["display:flex","display:block","display:grid"],a:0},
    {q:"Media query syntax uses?",o:["@media","@query","@screen"],a:0}
  ]},

  {id:"js",name:"JavaScript",lessons:[
    {id:"j1",title:"What is JavaScript?",content:"JS adds interactivity and logic to web pages."},
    {id:"j2",title:"Variables",content:"let x = 5; const y = 10;"},
    {id:"j3",title:"Data Types",content:"string, number, boolean, object, array, null, undefined."},
    {id:"j4",title:"Operators",content:"+ - * / % ++ --."},
    {id:"j5",title:"Conditions",content:"if, else, switch."},
    {id:"j6",title:"Loops",content:"for, while, do..while."},
    {id:"j7",title:"Functions",content:"function name(){ }"},
    {id:"j8",title:"Scope",content:"global vs local scope."},
    {id:"j9",title:"Events",content:"onclick, oninput, onsubmit."},
    {id:"j10",title:"DOM Basics",content:"document.getElementById(), querySelector()."},
    {id:"j11",title:"DOM Manipulation",content:"element.innerHTML, style, classList."},
    {id:"j12",title:"Forms Validation",content:"check values, preventDefault."},
    {id:"j13",title:"Arrays",content:"let arr=[1,2,3]; arr.push(4)."},
    {id:"j14",title:"Objects",content:"let obj={name:'John', age:30};"},
    {id:"j15",title:"JSON",content:"JSON.stringify() and JSON.parse()."},
    {id:"j16",title:"Fetch API",content:"fetch(url).then(res=>res.json())."},
    {id:"j17",title:"Async/Await",content:"async function(){ await fetch(); }"},
    {id:"j18",title:"LocalStorage",content:"localStorage.setItem('k','v');"},
    {id:"j19",title:"Error Handling",content:"try{ } catch(e){ }"},
    {id:"j20",title:"JS Best Practices",content:"Use const, avoid globals, comment, keep functions small."}
  ], exam:[
    {q:"JS is used for?",o:["Interactivity","Styling","Markup"],a:0},
    {q:"Declare variable with?",o:["let","css","html"],a:0},
    {q:"DOM stands for?",o:["Document Object Model","Data Object Model","Document Output Model"],a:0},
    {q:"Fetch returns?",o:["Promise","String","Array"],a:0}
  ]}
];

/* ---------- STATE ---------- */
let user, data;
function loadUser(u){
  user=u;
  data=JSON.parse(localStorage[user]);
  render();
}

/* ---------- NAV ---------- */
function render(){
  const nav=document.getElementById("nav");
  nav.innerHTML="";
  courses.forEach(c=>{
    const h=document.createElement("h4"); h.textContent=c.name; nav.appendChild(h);
    c.lessons.forEach((l,idx)=>{
      const id=c.id+"_"+l.id;
      const a=document.createElement("a");
      a.textContent=l.title;
      a.id=id;
      const lock = !isUnlocked(c.id, idx);
      if(lock) a.classList.add("locked");
      a.onclick=()=>loadLesson(c.id, idx);
      nav.appendChild(a);
    });
    const examLink=document.createElement("a");
    examLink.textContent="üß™ "+c.name+" Exam";
    examLink.onclick=()=>courseExam(c.id);
    if(!isCourseUnlocked(c.id)) examLink.classList.add("locked");
    nav.appendChild(examLink);
  });
  nav.innerHTML += `
    <h4>Platform</h4>
    <a onclick="finalExam()">üèÅ Final Exam</a>
    <a onclick="certificate()">üéì Certificate</a>
    <a onclick="openLeaderboard()">üèÜ Leaderboard</a>
    <a onclick="openTeacher()" ${user === "webwoner" ? "" : "style='opacity:.5;pointer-events:none'"}>üßë‚Äçüè´ Teacher Mode</a>
  `;
  loadLessonByProgress();
}

/* ---------- PROGRESSION ---------- */
function isUnlocked(courseId, lessonIndex){
  const courseIndex=courses.findIndex(c=>c.id===courseId);
  const globalIndex = courses.slice(0,courseIndex).reduce((sum,c)=>sum+c.lessons.length,0)+lessonIndex;
  return data.done.includes(globalIndex) || globalIndex===data.done.length;
}
function isCourseUnlocked(courseId){
  const courseIndex=courses.findIndex(c=>c.id===courseId);
  const prevLessons = courses.slice(0,courseIndex).reduce((sum,c)=>sum+c.lessons.length,0);
  return data.done.length>=prevLessons;
}
function loadLessonByProgress(){
  const idx=data.done.length;
  const courseIndex=findCourseByGlobal(idx);
  if(courseIndex>=0){
    const course=courses[courseIndex.course];
    loadLesson(course.id, course.lesson);
  }
}
function findCourseByGlobal(globalIdx){
  let sum=0;
  for(let i=0;i<courses.length;i++){
    if(globalIdx < sum + courses[i].lessons.length){
      return {course:i, lesson:globalIdx - sum};
    }
    sum += courses[i].lessons.length;
  }
  return null;
}

/* ---------- LESSON UI ---------- */
function loadLesson(courseId, idx){
  const course=courses.find(c=>c.id===courseId);
  if(!course) return;
  const lesson=course.lessons[idx];
  if(!isUnlocked(courseId, idx)) return alert("Locked");

  document.querySelectorAll("nav a").forEach(a=>a.classList.remove("active"));
  document.getElementById(courseId+"_"+lesson.id)?.classList.add("active");

  document.getElementById("main").innerHTML=`
    <div class="box">
      <strong>Progress:</strong> ${Math.round(data.done.length/totalLessons()*100)}%
      <br><small>Complete lessons to unlock next.</small>
    </div>
    <h1>${lesson.title}</h1>
    <p>${lesson.content}</p>

    <div class="editor">
      <textarea>${lessonExample(courseId, lesson.id)}</textarea>
      <button class="btn" onclick="run(this)">Run</button>
      <iframe></iframe>
    </div>

    <button class="btn" onclick="completeLesson('${courseId}','${lesson.id}')">‚úî Complete</button>

    <div class="box">
      <button class="btn" onclick="aiExplain('${lesson.title}')">ü§ñ AI Explain</button>
      <button class="btn" onclick="aiQuiz('${lesson.title}')">üß† Generate Quiz</button>
      <div id="aiout"></div>
    </div>
  `;
}

function lessonExample(courseId, lessonId){
  if(courseId==="html"){
    return `<h1>${lessonId}</h1>\n<p>Example content.</p>`;
  }
  if(courseId==="css"){
    return `<style>h1{color:var(--g)}</style>\n<h1>${lessonId}</h1>`;
  }
  return `<button onclick="alert('Hello')">Click</button>`;
}

function completeLesson(courseId, lessonId){
  const globalIndex = getGlobalIndex(courseId, lessonId);
  if(!data.done.includes(globalIndex)) data.done.push(globalIndex);
  save();
  render();
}

/* ---------- EXAMS ---------- */
function courseExam(courseId){
  const course=courses.find(c=>c.id===courseId);
  if(!isCourseUnlocked(courseId)) return alert("Finish previous courses first");
  const passed = data.scores[courseId];
  if(passed) return alert("Exam already passed");

  const q=course.exam;
  quizScreen(course.name+" Exam", q, (score)=>{
    if(score>=75){
      data.scores[courseId]=true;
      save();
      alert("Passed "+course.name+" exam!");
      render();
    } else alert("Fail. Score: "+score+"%. Need 75%");
  });
}

function finalExam(){
  if(!allCoursePassed()) return alert("Pass all course exams first");
  if(data.exam) return alert("Final exam already passed");

  const questions=[
    {q:"HTML stands for?",o:["Hyper Text Markup Language","High Text Machine Language","Hyperlinks Text Mark Language"],a:0},
    {q:"CSS is used for?",o:["Styling","Logic","Data"],a:0},
    {q:"JS is used for?",o:["Interactivity","Markup","Styling"],a:0},
    {q:"Use <a> for?",o:["Links","Images","Tables"],a:0},
    {q:"Use flexbox for?",o:["Layout","Text only","Audio"],a:0}
  ];

  quizScreen("Final Exam", questions, (score)=>{
    if(score>=80){
      data.exam=true;
      save();
      alert("Final exam passed!");
    } else alert("Final exam failed: "+score+"%");
  });
}

function allCoursePassed(){
  return courses.every(c=>data.scores[c.id]);
}

function quizScreen(title, questions, callback){
  const html = `
    <h1>${title}</h1>
    ${questions.map((q,i)=>`
      <div class="box">
        <strong>${i+1}. ${q.q}</strong>
        ${q.o.map((opt,j)=>`
          <label><input type="radio" name="q${i}" value="${j}"> ${opt}</label>
        `).join("")}
      </div>
    `).join("")}
    <button class="btn" onclick="submitQuiz(${questions.length})">Submit</button>
  `;
  document.getElementById("main").innerHTML=html;

  window.submitQuiz = (n)=>{
    let correct=0;
    for(let i=0;i<n;i++){
      const sel=document.querySelector(`input[name="q${i}"]:checked`);
      if(sel && parseInt(sel.value)===questions[i].a) correct++;
    }
    const score=Math.round(correct/n*100);
    callback(score);
  };
}

/* ---------- AI ---------- */
async function aiExplain(text){
  document.getElementById("aiout").textContent="Thinking...";
  const r=await ai(`Explain ${text} for beginners`,{max_new_tokens:90});
  document.getElementById("aiout").textContent=r[0].generated_text;
}
async function aiQuiz(text){
  document.getElementById("aiout").textContent="Generating quiz...";
  const r=await ai(`Generate 1 multiple choice question about ${text}`,{max_new_tokens:80});
  document.getElementById("aiout").textContent=r[0].generated_text;
}

/* ---------- SANDBOX ---------- */
function run(btn){
  btn.nextElementSibling.srcdoc=btn.previousElementSibling.value;
}

/* ---------- LEADERBOARD ---------- */
function openLeaderboard(){
  let html="<h1>Leaderboard</h1>";
  const users=Object.keys(localStorage).filter(k=>k!=="session");
  const list=users.map(u=>{
    try{
      const d=JSON.parse(localStorage[u]);
      if(!d.done) return null;
      const pct=Math.round(d.done.length/totalLessons()*100);
      return {u,pct};
    }catch{return null}
  }).filter(Boolean).sort((a,b)=>b.pct-a.pct);

  html += list.map(x=>`<p>${x.u}: ${x.pct}%</p>`).join("");
  document.getElementById("main").innerHTML=html;
}

/* ---------- CERTIFICATE ---------- */
function certificate(){
  if(!data.exam) return alert("Complete all lessons + final exam first");
  const c=document.createElement("canvas");
  c.width=800; c.height=400;
  const x=c.getContext("2d");
  x.fillStyle="#fff"; x.fillRect(0,0,800,400);
  x.fillStyle="#000"; x.font="36px serif";
  x.fillText("Certificate of Completion",150,150);
  x.font="22px serif";
  x.fillText(user,350,230);
  x.fillText(new Date().toDateString(),300,290);
  const a=document.createElement("a");
  a.href=c.toDataURL(); a.download="certificate.png"; a.click();
}

/* ---------- TEACHER MODE ---------- */
function openTeacher(){
  if(user !== "webwoner") return alert("Access denied");
  const html = `
    <h1>Teacher / Admin Mode</h1>
    <div class="box">
      <h3>Add Lesson</h3>
      <select id="tc"></select>
      <input id="tt" placeholder="Lesson title">
      <textarea id="tcnt" placeholder="Lesson content"></textarea>
      <button class="btn" onclick="addLesson()">Add Lesson</button>
    </div>

    <div class="box">
      <h3>Add Exam Question</h3>
      <select id="qc"></select>
      <input id="qq" placeholder="Question">
      <input id="qo1" placeholder="Option 1">
      <input id="qo2" placeholder="Option 2">
      <input id="qo3" placeholder="Option 3">
      <input id="qa" placeholder="Correct option (0/1/2)">
      <button class="btn" onclick="addQuestion()">Add Question</button>
    </div>

    <div class="box">
      <h3>User Management</h3>
      <input id="newUser" placeholder="New username">
      <input id="newPass" type="password" placeholder="Password">
      <button class="btn" onclick="createUser()">Create User</button>
      <br><br>
      <button class="btn" onclick="resetAll()">Reset All Data</button>
    </div>
  `;
  document.getElementById("main").innerHTML=html;
  populateTeacher();
}

function populateTeacher(){
  const tc=document.getElementById("tc");
  const qc=document.getElementById("qc");
  tc.innerHTML="";
  qc.innerHTML="";
  courses.forEach(c=>{
    const opt=document.createElement("option"); opt.value=c.id; opt.textContent=c.name;
    tc.appendChild(opt);
    qc.appendChild(opt.cloneNode(true));
  });
}

function addLesson(){
  const courseId=document.getElementById("tc").value;
  const title=document.getElementById("tt").value;
  const content=document.getElementById("tcnt").value;
  if(!title||!content) return alert("Fill title + content");
  const course=courses.find(c=>c.id===courseId);
  course.lessons.push({id:"l"+(course.lessons.length+1),title,content});
  saveCourses();
  render();
  alert("Lesson added");
}

function addQuestion(){
  const courseId=document.getElementById("qc").value;
  const q=document.getElementById("qq").value;
  const o1=document.getElementById("qo1").value;
  const o2=document.getElementById("qo2").value;
  const o3=document.getElementById("qo3").value;
  const a=parseInt(document.getElementById("qa").value);
  if(!q||!o1||!o2||!o3||isNaN(a)) return alert("Fill all");
  const course=courses.find(c=>c.id===courseId);
  course.exam.push({q,o:[o1,o2,o3],a});
  saveCourses();
  alert("Question added");
}

async function createUser(){
  const u=document.getElementById("newUser").value.trim();
  const p=document.getElementById("newPass").value;
  if(!u||!p) return alert("Fill");
  if(localStorage[u]) return alert("User exists");
  const pw=await hash(p);
  localStorage[u]=JSON.stringify({pw,done:[],scores:{},exam:false,admin:false});
  alert("User created");
}

function resetAll(){
  if(!confirm("Reset all users and progress?")) return;
  Object.keys(localStorage).forEach(k=>localStorage.removeItem(k));
  location.reload();
}

/* ---------- SAVE / LOAD ---------- */
function save(){
  localStorage[user]=JSON.stringify(data);
}
function saveCourses(){
  localStorage.courses=JSON.stringify(courses);
}
function loadCourses(){
  const stored=localStorage.courses;
  if(stored){
    try{
      const parsed=JSON.parse(stored);
      if(Array.isArray(parsed)) courses.splice(0,courses.length,...parsed);
    } catch{}
  }
}
loadCourses();

/* ---------- UTILS ---------- */
function totalLessons(){ return courses.reduce((sum,c)=>sum+c.lessons.length,0); }
function getGlobalIndex(courseId, lessonId){
  let sum=0;
  for(const c of courses){
    if(c.id===courseId){
      const idx=c.lessons.findIndex(l=>l.id===lessonId);
      return sum + idx;
    }
    sum += c.lessons.length;
  }
  return -1;
}

/* ---------- VOICE ---------- */
function voice(){
  const r=new webkitSpeechRecognition();
  r.onresult=e=>aiExplain(e.results[0][0].transcript);
  r.start();
}

/* ---------- DARK ---------- */
function toggleDark(){document.body.classList.toggle("dark")}

/* ---------- START ---------- */
loadUser(localStorage.session);
</script>
</body>
</html>
